<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arduino Master Terminal 2026</title>
    <!-- FIXES the favicon.ico 404 error by providing an empty icon link -->
    <link rel="icon" href="data:,">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 10px; width: 100%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        input, button { padding: 12px; margin: 5px 0; border-radius: 6px; border: 1px solid #444; width: 100%; box-sizing: border-box; font-size: 14px; }
        input { background: #2c2c2c; color: #fff; }
        button { background: #007bff; color: white; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background: #0056b3; }
        #terminal { background: #000; color: #00ff00; height: 300px; overflow-y: auto; padding: 15px; border: 1px solid #333; margin-top: 10px; font-family: 'Courier New', monospace; text-align: left; }
    </style>
</head>
<body>

    <div class="box">
        <h3>1. NTFY Configuration</h3>
        <input type="text" id="topic" placeholder="Enter ntfy Topic Name">
        <input type="password" id="token" placeholder="Access Token (Optional)">
        
        <button id="connectBtn">2. Connect Arduino</button>
        
        <h3 style="margin-top:20px;">3. Serial Terminal</h3>
        <div id="terminal">System: Waiting for connection...</div>
        
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <input type="text" id="cmd" placeholder="Type command to Arduino...">
            <button id="sendBtn" style="width: 80px;">Send</button>
        </div>
    </div>

    <script>
        let port, writer;
        const terminal = document.getElementById('terminal');

        function log(msg, color = "#0ff") {
            terminal.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Unified Function: Sends to phone via proxy to bypass DNS blocks
        async function triggerAlert(message) {
            const topic = document.getElementById('topic').value.trim();
            const token = document.getElementById('token').value.trim();
            
            if (!topic) {
                log("Error: Topic name required!", "red");
                return;
            }

            const proxy = 'https://cors-anywhere.herokuapp.com';
            const target = `https://ntfy.sh{topic}`;
            
            const headers = { 
                'Title': 'Arduino Alert',
                'X-Requested-With': 'XMLHttpRequest' 
            };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            try {
                const response = await fetch(proxy + target, { 
                    method: 'POST', 
                    body: message, 
                    headers: headers
                });

                if (response.ok) {
                    log("Ntfy: SUCCESS! Message Delivered.", "#0f0");
                } else if (response.status === 403) {
                    log("Proxy Error: Visit ://cors-anywhere.herokuapp.com and click 'Request Access'.", "orange");
                } else {
                    log(`Ntfy Server Error: ${response.status}`, "orange");
                }
            } catch (e) {
                log(`Network Blocked: ${e.message}`, "red");
            }
        }

        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('cmd').value;
            if (!writer) return log("Error: Not Connected", "red");
            const encoder = new TextEncoder();
            await writer.write(encoder.encode(val + "\n"));
            log(`Sent to Arduino: ${val}`, "#fff");
            document.getElementById('cmd').value = "";
        };

        document.getElementById('connectBtn').onclick = async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                document.getElementById('connectBtn').disabled = true;
                log("SERIAL OPENED", "#fff");

                writer = port.writable.getWriter();
                const textDecoder = new TextDecoderStream();
                port.readable.pipeTo(textDecoder.writable);
                const reader = textDecoder.readable.getReader();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        const msg = value.trim();
                        log(msg, "#0f0");
                        
                        // Keywords are case-sensitive. Arduino MUST send "ALERT" in caps.
                        if (msg.includes("ALERT")) {
                            triggerAlert(msg);
                        }
                    }
                }
            } catch (e) { 
                log(`Error: ${e.message}`, "red"); 
            }
        };
    </script>
</body>
</html>

